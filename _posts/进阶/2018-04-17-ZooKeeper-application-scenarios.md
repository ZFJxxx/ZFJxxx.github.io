---
layout: post
title:  ZooKeeper应用场景
date:   2018-04-17 18:10:10
categories: 分布式
tags: ZooKeeper
keywords: ZooKeeper
description: 
---
--------------------------
ZooKeeper是hadoop衍生出来的子项目，因为之间hadoop生态圈的软件都是以动物的名字命名，比如hadoop(一头玩具小象的名字)、impala(黑斑羚)、shark(鲨鱼)、hive（蜂巢）。Zookeeper就是为了协调这些分布式程序的数据一致性问题，所以该项目起名Zookeeper。

ZooKeeper是一个典型的发布/订阅模式的分布式数据管理协调框架，开发人员可以使用它来进行分布式数据的发布和订阅。我们现在就开深入了解典型的分布式应用场景。

------------------------------------------------------------
## 数据发布/订阅
数据发布订阅系统，就是将发布者将数据发布到ZooKeeper的一个或一系列节点上，供订阅者进行数据订阅，实现配置信息的集中式管理和数据的动态更新。

发布/订阅系统一般有两种设计模式，分别是Push和Pull。Push模式中服务端主动将数据更新发送给所有订阅者；Pull模式是订阅者通过定时轮询主动请求获取最新数据。ZooKeeper采用Push和Pull相结合的的模式：订阅者向发布者订阅自己关注的节点，一旦节点发生数据变更，发布者就给相应的客户端发布一个Watcher事件，订阅者收到消息后主动到服务端获取最新数据。

### 例子
比如我们将配置信息统一放到ZooKeeper上集中管理，那么应用在启动时会主动到ZooKeeper服务端获取一次配置信息，同时在指定节点上注册一个Watcher监听，这样只要配置信息发生变更，服务端都会通知所有订阅的客户端，从而获取到最新的配置信息。

比如在系统中一些通用的配置信息，例如机器列表信息、数据库配置等。这些全局配置信息通常具有：
*  数据量小
*  数据内容运行时发生动态变化
*  集群众各机器共享，配置一致

这类配置信息通常的做法是放在本地配置文件或者内存变量中，在系统运行过程中定时读取文件，在集群规模不大,配置变更不频繁的情况下，能够解决配置管理问题。但是机器集群规模变大，变更频繁之后，我们希望能够快速做到全局配置信息变更的目标就变得难以实现了。使用Zookeeper，将配置信息交给Zookeeper管理，一旦节点数据发生变更，服务端就会马上将数据变更的信息发给所有注册watcher监听的客户端，客户端就能够及时获取到最新的数据。

-----------------------------
## 负载均衡
分布式系统中，都会使用负载均衡来进行资源的的分配负载，以达到资源优化、最大化吞吐量、最小化响应时间和避免过载的目的。其中比较典型的就是DNS服务

### 弊端
两种方法：
（1）注册域名，只能注册有限的域名，应用多了难以应付

（2）内部开发，实际开发往往使用本地HOST绑定域名实现域名解析，在Hosts中配置域名和IP的映射关系，不用请求网络上的DNS服务器。但是在上线时需要解绑域名，在机器规模很大的时候很费时，更换域名也不方便。


### 动态DNS
ZooKeeper实现动态负载均衡（Dynamic DNS,简称DDNS）。什么是DDNS？

> DDNS是将用户的动态IP地址映射到一个固定的域名解析服务上，用户每次连接网络的时候客户端程序就会通过信息传递把该主机的动态IP地址传送给位于服务商主机上的服务器程序，服务器程序负责提供DNS服务并实现动态域名解析。

如图，每个应用都可以创建一个属于自己的数据节点做域名配置根节点，例如app1，在这个节点上，将自己的域名配置上去。比如：

    #多个ip:port
    192.168.0.1:8080 ， 192.168.0.2:8080

这样就配置好了一个域名解析。传统的DNS解析，我们不需要关心域名解析过程。在DDNS中域名解析过程由应用自己负责。应用先从域名节点获取一份IP地址和端口的配置，自行解析。同时还会在域名节点上注册一个数据变更Watcher监听,以便收到域名变更通知。

### 域名变更
当遇到域名对应的IP地址或者端口变更，就要进行域名变更操作。在DDNS中，我们只需要对指定域名节点进行变更操作，ZooKeeper就会向定于的客户端发送这个事件通知，应用接收到通知之后就会进行域名配置的获取。


--------------------------------

## 命名服务

也就是用ZooKkeeper实现分布式系统中的全局唯一ID，UUID长度过长，效率低。

* 客户端根据自己的任务类型，在指定类型的任务下面通过调用create( )接口创建一个顺序节点，比如“job-”节点。创建完毕之后，create（）接口会返回一个完整节点名，比如“job - 00003”。
* 客户端拿到返回值，拼接上type类型，如“type1-job-00003”，这就可以作为全局ID

ZooKeeper中，每个数据节点都能维护一份子节点的顺序顺列，客户端创建一个顺序子节点的时候ZooKkeeper会自动以后缀的形式在子节点上添加一个序号。这个场景就利用了ZooKeeper这个特性。    

---------------------------------------  
## 分布式协调/通知

对于分布式系统通常需要一个协调者（Coordinator）来控制整个系统的运行流程，比如分布式事务、机器间的相互协调。Coordinator能够大大减少系统之间的耦合，提高系统可扩展性。

ZooKeeper中的Watcher注册与异步通知机制，能够很好的实现分布式环境下不同系统之间的协调，实现数据的分布式一致性。通常的做法是不同的客户端对ZooKeeper上同一个数据节点进行Watcher注册，监听数据节点的变化。

### 分布式系统机器间通信方式
在分布式系统中，系统机器间的通信无外乎心跳检测、工作进度汇报、系统调度三种类型。

**心跳检测**

心跳检测是分布式环境中不同机器间检测彼此是否正常运行的机制。通常通过主机之间是否可以通PING、或者通过TCP连接固有的心跳检测机制实现上层机器的心跳检测。

基于ZooKeeper的临时节点的特性，让不同的机器在ZooKeeper的机器都在ZooKeeper的一个指定节点下面创建临时子节点，不同的机器之间可以通过这个临时节点是否存在来判断客户端是否存活。这样用ZooKeeper实现心跳检测，不需要监测系统和被检测系统之间直接关联，减少了耦合。

**工作进度汇报**

一个任务分发系统将任务分发到分布式系统不同的机器上执行后，需要将各机器的任务执行进度汇报给分发系统，就可以通过ZooKeeper实现。

在ZooKeeper上选择一个节点，每个任务客户端都在这个节点下创建临时节点，这样可以同时实现两个功能：
*  通过判断临时节点是否存在来确定任务机器是否存活
*  各个任务机器会实时地将自己的任务执行进度写到这个临时节点上，一遍中心系统能够实时地获取任务进度。

**系统调度**

ZooKeeper能够实现另一种系统调度模式：一个分布式系统由控制台和一些客户端系统两部分组成，控制台将一些指令信息发送给所有客户端，控制他们的业务逻辑，后台管理人员修改ZooKeeper某些节点的数据，ZooKeeper进一步将这些数据以时间通知的形式发送给对应的订阅客户端。

总之，ZooKeeper实现分布式系统机器间的通信，能够大量省去底层网络通信，降低系统之间的耦合，轻松的实现异构系统之间的灵活通信。

---------------------------
## 集群管理
在大规模的机器集群中，我们要实现集群控制和集群监控两个功能。比如：
 * 知道集群中有多少机器在工作
 * 对集群中每台机器的运行状态进行收集
 * 对集群中机器进行上下线操作
 
ZooKeeper有两大特性：
 * 客户端如果对ZooKeeper的一个数据节点注册Watcher监听，那么数据节点或者子节点数据变更时ZooKeeper就会向订阅用户发送通知
 * 对在ZooKeeper上创建临时节点，一旦客户端与服务器之间失效，那么该临时节点也会被清除。

利用这两点就能实现对集群机器存活性监控的系统。比如：监控直通在/clusterServers节点注册一个Watcher监听，只要进行添加机器的操作，/clusterServers节点下就会增添一个临时节点：/clusterServers/[Hostname]。这样就能实时检测到机器的变动情况了。

--------------------------------------------
## Master选举
