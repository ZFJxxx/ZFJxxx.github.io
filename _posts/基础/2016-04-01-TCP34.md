---
layout: post
title:  TCP/IP 三次握手和四次挥手
date:   2017-12-30 11:15:10
categories:  基础
tags: NetWork
keywords: tcp
description: 
---
----------------------------------
## TCP
TCP是面向连接的运输层协议，它提供可靠交付的、全双工的、面向字节流的点对点服务。HTTP协议便是基于TCP协议实现的。（虽然作为应用层协议，HTTP协议并没有明确要求必须使用TCP协议作为运输层协议，但是因为HTTP协议对可靠性的的要求，默认HTTP是基于TCP协议的。若是使用UDP这种不可靠的、尽最大努力交付的运输层协议来实现HTTP的话，那么TCP协议的流量控制、可靠性保障机制等等功能就必须全部放到应用层来实现）

## TCP协议的报文格式

TCP报文段的首部分为固定部分和选项部分，固定部分长20byte，而选项部分长度可变。（若整个首部长度不是4byte的整数倍的话，则需要用填充位来填充）在固定首部中，与本文密切相关的是以下几项：
* seq（序号）：TCP连接字节流中每一个字节都会有一个编号，而本字段的值指的是本报文段所发送数据部分第一个字节的序号。
* ack（确认号）：表示期望收到的下一个报文段数据部分的第一个字节的编号，编号为ack-1及以前的字节已经收到。
* SYN（synchronous / 同步）：当本字段为1时，表示这是一个连接请求或者连接接受报文。
* ACK（Acknowledgement / 确认）：仅当本字段为1时，确认号才有效。
* FIN：用来释放一个连接。当本字段为1时，表示此报文段的发送端数据已发送完毕，要求释放运输连接。


----------
##  TCP的运输连接管理
运输连接具有三个阶段：连接建立、数据传送以及连接释放。运输连接管理就是对连接建立以及连接释放过程的管控，使得其能正常运行，达到这些目的：使通信双方能够确知对方的存在、可以允许通信双方协商一些参数（最大报文段长度、最大窗口大小等等）、能够对运输实体资源进行分配（缓存大小等）。TCP连接的建立采用客户-服务器模式：主动发起连接建立的应用进程叫做客户，被动等待连接建立的应用进程叫做服务器。

**连接建立阶段：**

**第一次握手**：客户端的应用进程主动打开，并向服务端发出请求报文段。其首部中：SYN=1,seq=x。

**第二次握手**：服务器应用进程被动打开。若同意客户端的请求，则发回确认报文，其首部中：SYN=1,ACK=1,ack=x+1,seq=y。

**第三次握手**：客户端收到确认报文之后，通知上层应用进程连接已建立，并向服务器发出确认报文，其首部：ACK=1,ack=y+1。当服务器收到客户端的确认报文之后，也通知其上层应用进程连接已建立。
在这个过程中，通信双方的状态如下图。
其中 CLOSED：关闭状态、LISTEN：收听状态、SYN-SENT：同步已发送、SYN-RCVD：同步收到、ESTAB-LISHED：连接已建立

![enter image description here](http://p7lixluhf.bkt.clouddn.com/%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B.jpg)

**TCP 为什么是三次握手，为什么不是两次或四次？**
四次次数太多，两次的话如果客户端没有收到服务器的信息出现了问题，这样会造成资源的浪费，客户端和服务端会一直在等待对方的消息，造成阻塞。


**连接释放阶段：**

**第一次挥手**：数据传输结束以后，客户端的应用进程发出连接释放报文段，并停止发送数据，其首部：FIN=1,seq=u。

**第二次挥手**：服务器端收到连接释放报文段之后，发出确认报文，其首部：ack=u+1,seq=v。此时本次连接就进入了半关闭状态，客户端不再向服务器发送数据。而服务器端仍会继续发送。

**第三次挥手**：若服务器已经没有要向客户端发送的数据，其应用进程就通知服务器释放TCP连接。这个阶段服务器所发出的最后一个报文的首部应为：FIN=1,ACK=1,seq=w,ack=u+1。

**第四次挥手**：客户端收到连接释放报文段之后，必须发出确认：ACK=1,seq=u+1,ack=w+1。 再经过2MSL(最长报文端寿命)后，本次TCP连接真正结束，通信双方完成了他们的告别。
在这个过程中，通信双方的状态如下图。
其中：ESTAB-LISHED：连接建立状态、FIN-WAIT-1：终止等待1状态、FIN-WAIT-2：终止等待2状态、CLOSE-WAIT：关闭等待状态、LAST-ACK：最后确认状态、TIME-WAIT：时间等待状态、CLOSED：关闭状态
![enter image description here](http://p7lixluhf.bkt.clouddn.com/%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B.png)

**第一次挥手**：Client发送一个FIN=1的TCP报文段到Server，表示自己没有数据要发送了，想断开连接。

**第二次挥手**：Server收到上面的报文段后，发送ACK确认已收到。若Server还有需要发送的数据，继续发送完毕。

**第三次挥手**：当Server也没有要继续发送的数据了，发送一个FIN=1的TCP报文段到Server，表示自己没有数据要发送了，将断开连接，并且断开Server到Client的连接，释放相应的资源。

**第四次挥手**：Client收到Server的FIN=1的TCP报文段，发送ACK确认消息已经收到。Client做完5中的事情后，等待2MSL，没啥音信了，就认为对面已经正确关闭了，自己也断开了到Server的TCP连接。
