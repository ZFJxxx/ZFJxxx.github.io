---
layout: post
title:  TCP/IP 网络层
date:   2017-12-09 19:15:10
categories:  基础
tags:  NetWork
keywords: 
description:         
---

## 网络层


首先我们看看网络层在OSI 7层协议和TCP/IP 4层协议中所处的位置

![enter image description here](http://p7lixluhf.bkt.clouddn.com/OSI.jpg)

这一层主要是按照复杂的分布式算法，动态的更新路由表选择路由路径，然后根据路由表转发用户的IP数据报。

### 名称解释

**IPV4**

**主机号全为1表示本网络的广播地址：**对于10.1.1.0 （255.255.255.0 ）网段，其广播地址为10.1.1.255 （255 即为2 进制的11111111 ），当发出一个目的地址为10.1.1.255 的分组（封包）时，它将被分发给该网段上的所有计算机。

**主机号	全为0表示本网络本身：**比如 10.1.1.0


**网络地址转换（NAT，Network Address Translation)**

将本地IP地址（如企业内部Internet）转换成公用IP地址，这样就对外隐藏了内部管理的IP地址。它使得整个专用的网络只需要一个全球IP就OK了，因为本地IP地址可重复使用，所以NAT大大的节省了IP地址的消耗。RFC为私有网络预留出了三个IP 地址块，如下：
```
A 类：1个A类网段    10.0.0.0～10.255.255.255
B 类：16个B类网段   172.16.0.0～172.31.255.255
C 类：256个C类网段  192.168.0.0～192.168.255.255
```
上述三个范围内的地址不会在因特网上被分配，因此可以不必向ISP 或注册中心申请而在公司或企业内部自由使用。

加入我们宿舍迁入了一条网线，这样我们就获得了一个全球IP（例如111.47.18.46），宿舍类4台主机使用192.168.0.0网段。将网线插入WAN口，开启NAT，就会有一个NAT转换表：

![enter image description here](http://p7lixluhf.bkt.clouddn.com/nat.jpg)

当路由器从LAN口收到源IP和源端口号为192.168.0.1：2233的数据报时，就将其映射为138.76.29.7：5001，然后通过WAN端发送到因特网上。

**子网、子网掩码、网关**
IP地址由两部分组成，即网络号（Network ID）和主机号（Host ID）。网络号标识的是Internet上的一个子网，而主机号标识的是子网中的某台主机。网络地址分解成两个域后，带来了一个重要的优点：IP数据包从网际上的一个网络到达另一个网络时，选择路径可以基于网络而不是主机。

所有网络都有都必须采用子网掩码，如果网络没有划分子网，那么就采用默认的子网掩码。

比如：111.47.18.46  子网掩码：255.255.255.0   那么该主机所在子网为111.47.18.0

**ARP**

地址解析协议，即ARP（Address Resolution Protocol），是根据IP地址获取物理地址的一个TCP/IP协议。ARP是解决统一局域网上的主机路由器的IP地址和硬件地址（MAC）的映射问题。

ARP工作原理
* 1：首先，每个主机都会在自己的ARP缓冲区中建立一个ARP列表，以表示IP地址和MAC地址之间的对应关系。本机缓存是有生存期的。

* 2：当源主机要发送数据时，首先检查ARP列表中是否有对应IP地址的目的主机的MAC地址，如果有，就先在其ARP高速缓存中查看有无主机B的IP地址，如果有，就在ARP高速缓存器中查找出其对应的硬件地址，再把这个硬件地址写入mac帧中，然后通过局域网把mac帧发往此硬件地址，如果没有，就会自动自动运行ARP，然后按以下步骤找出目的的硬件地址：
（1）就向本网段的所有主机发送ARP数据包，该数据包包括的内容有：源主机 IP地址，源主机MAC地址，目的主机的IP 地址。 
（2）当本网络的所有主机收到该ARP数据包时，首先检查数据包中的IP地址是否是自己的IP地址，如果不是，则忽略该数据包，如果是，则首先从数据包中取出源主机的IP和MAC地址写入到ARP列表中，如果已经存在，则覆盖，然后将自己的MAC地址写入ARP响应包中，告诉源主机自己是它想要找的MAC地址。 
（3）源主机收到ARP响应包后。将目的主机的IP和MAC地址写入ARP列表中并保留一定时间，并利用此信息发送数据，下次请求时直接查询ARP缓存以节约资源，缓存生存期结束后，将再次重复上面的过程。 
（4）如果源主机一直没有收到ARP响应数据包，表示ARP查询失败。

## IP

![enter image description here](http://p7lixluhf.bkt.clouddn.com/IP.jpg)

**IP首部**

![enter image description here](http://p7lixluhf.bkt.clouddn.com/IP1.jpg)

* 1.版本：用于标识IP协议版本，目前广泛为4
* 2.首部长度：用于标识首部的长度，一般只推荐使用20字节的固定长度。
* 3.总长度：16位；标识IP数据报的总长度，最大为：2^16 -1 = 65535字节。
* 4.标识、标志、片偏移：用于标识IP数据报，如果因为首部+数据的长度长度超过MTU限制，IP数据报需要进行分片发送，这三个量就是为了保证分片之后packet的正确位置不被打乱
* 5.生存时间：8位；标识IP数据报可以经过的路由器数的最大值。
* 6.协议：8位；代表上层传输层协议的类型，1代表ICMP，2代表IGMP，6代表TCP，17代表UDP。
* 7.校验和：16位；用于验证数据完整性，目前只校验packet首部。
* 8.源地址：源IP地址
* 9.目的地址：目的IP地址

## ICMP协议

在基于IP数据报的网络体系中，网关必须自己处理数据报的传输工作，而IP协议自身没有内在机制来获取差错信息并处理。为了处理这些错误，TCP/IP设计了ICMP协议，当某个网关发现传输错误时，立即向信源主机发送ICMP报文，报告出错信息，让信源主机采取相应处理措施，它是一种差错和控制报文协议，不仅用于传输差错报文，还传输控制报文。

ICMP报文主要为差错报告。当路由器或者主机不能交付数据报、路由器或者主机由于阻塞丢弃报文、路由器收到生成时间TTL为0的数据报、路由器或者主机收到数据报的首部中有字段的值不正确时，都会发送ICMP差错报文。



## IP组播和IGMP协议

组播仅应用于UDP，它把一个packet发送给多个目的地主机。

组播并不是让源主机给没一个目的地都发送一个单独的packet，而是源主机把一个packet发送给一个组播地址，该组播地址标识一组地址，然后将packet的拷贝发送给改组中的每一个主机。

主机可以选择加入或者离开一个组，并且可以同时属于多个组。

组播IP地址的使用范围是：224.0.0.0 - 239.255.255.255

![enter image description here](http://p7lixluhf.bkt.clouddn.com/NETCOM_3.jpg)
以上就是单播和组播的区别。

**IGMP协议**

IGMP协议是让连接在**本地局域网**上的组播路由器知道**本局域网**上是否有主机参加或者推出了某个组播组。

它并非是因特网范围内对所有组播成员进行管理的协议。

IGMP分为两个阶段：

* 1.当某个主机加入新的组播组时，该主机应向组播组的组播地址发送一个IGMP报文，声明自己是改组成员。本地的组播路由器收到IGMP报文之后，将组成员关系转发给Internet上其他组播路由器。

* 2.组成员关系是动态的，本地组播路由器要周期性地探寻本地局域网上的主机，以便知道这些主机是否还继续是组的成员。组中的主机有相应就认为继续是的，没有相应就认为不是的。